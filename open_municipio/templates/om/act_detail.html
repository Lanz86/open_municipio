{% extends "base.html" %}
{% load comments %}
{% load voting_tags %}

{% block head_includes %}
<link href="{{ STATIC_URL }}css/voting.css" rel="stylesheet">
<script>
    $(document).ajaxSend(function(event, xhr, settings) {
	function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
		var cookies = document.cookie.split(';');
		for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
			cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			break;
                    }
		}
            }
            return cookieValue;
	}
	function sameOrigin(url) {
            // url could be relative or scheme relative or absolute
            var host = document.location.host; // host + port
            var protocol = document.location.protocol;
            var sr_origin = '//' + host;
            var origin = protocol + sr_origin;
            // Allow absolute or scheme relative URLs to same origin
            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
		(url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
		// or any other URL that isn't scheme relative or absolute i.e relative.
		!(/^(\/\/|http:|https:).*/.test(url));
	}
	function safeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}
	
	if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
	}
    });

function vote_act(act_id, direction) {
    $.post('/atti/' + act_id + '/' + direction + 'vote/', {HTTP_X_REQUESTED: 'XMLHttpRequest'}, 
	   function(data) {
               if (data.success == true) {
		   var $box = $('#act_' + act_id);
                   $box.find(".score").text(data.score.score);
                   $box.find(".num_votes").text(data.score.num_votes);
                   if (direction == "up") {
 		       $box.find("ul").replaceWith(
'<ul>' +
  '<li><a onclick=\'vote_act("' + act_id + '", "clear");\'><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up.png" /></a></li>' + 
  '<li><a onclick=\'vote_act("' + act_id + '", "down");\'><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>' + 
'</ul>'
);
		   }
		   else if (direction == "down") {
		       $box.find("ul").replaceWith(
'<ul>' +
  '<li><a onclick=\'vote_act("' + act_id + '", "up");\'><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>' +
  '<li><a onclick=\'vote_act("' + act_id + '", "clear");\'><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down.png" /></a></li>' + 
'</ul>'
);
		   }
		   else {
		       $box.find("ul").replaceWith(
'<ul>' + 
  '<li><a onclick=\'vote_act("' + act_id + '", "up");\'><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>' + 
  '<li><a onclick=\'vote_act("' + act_id + '", "down");\'><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>' + 
'</ul>');
 		   }
	       }
	       else {
		   alert('ERROR: ' + data.error_message);
	       }
           }, 'json'
	  )
}

function vote_comment(comment_id, direction) {
    $.post('/commenti/' + comment_id + '/' + direction + 'vote/', {HTTP_X_REQUESTED: 'XMLHttpRequest'}, 
	   function(data) {
               if (data.success == true) {
		   var $box = $('#comment_' + comment_id);
                   $box.find(".score").text(data.score.score);
                   $box.find(".num_votes").text(data.score.num_votes);
                   if (direction == "up") {
 		       $box.find("ul").replaceWith(
'<ul>' +
  '<li><a onclick=\'vote_comment("' + comment_id + '", "clear");\'><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up.png" /></a></li>' + 
  '<li><a onclick=\'vote_comment("' + comment_id + '", "down");\'><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>' + 
'</ul>'
);
		   }
		   else if (direction == "down") {
		       $box.find("ul").replaceWith(
'<ul>' +
  '<li><a onclick=\'vote_comment("' + comment_id + '", "up");\'><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>' +
  '<li><a onclick=\'vote_comment("' + comment_id + '", "clear");\'><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down.png" /></a></li>' + 
'</ul>'
);
		   }
		   else {
		       $box.find("ul").replaceWith(
'<ul>' + 
  '<li><a onclick=\'vote_comment("' + comment_id + '", "up");\'><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>' + 
  '<li><a onclick=\'vote_comment("' + comment_id + '", "down");\'><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>' + 
'</ul>');
 		   }
	       }
	       else {
		   alert('ERROR: ' + data.error_message);
	       }
           }, 'json'
	  )
}
</script>
{% endblock %}
{% block title %}| Act list {% endblock %}

{% block content %}
{% get_comment_count for act as comment_count %}
{% get_comment_list for act as comment_list %}
{% get_comment_form for act as form %}
  <section id="content"><!-- #content -->
    <h1>Act title: {{ act.title }}</h1>
    <p>{{ act.text }}</p>

    {% score_for_object act as act_score %}
    {% if request.user.is_authenticated %}
    {% vote_by_user request.user on act as vote %}
    <div class="voting-box" id="act_{{ object.id }}">
      <h1>Vote this act</h1>
      <ul>
	{% if vote.vote < 0 %}
	<li><a onclick="vote_act('{{ object.id }}', 'up');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>
	<li><a onclick="vote_act('{{ object.id }}', 'clear');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down.png" /></a></li>
	{% else %}{% if vote.vote > 0 %}
	<li><a onclick="vote_act('{{ object.id }}', 'clear');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up.png" /></a></li>
	<li><a onclick="vote_act('{{ object.id }}', 'down');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>
	{% else %}
	<li><a onclick="vote_act('{{ object.id }}', 'up');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>
	<li><a onclick="vote_act('{{ object.id }}', 'down');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>
	{% endif %}
	{% endif %}
      </ul>
      <div class="voting-score">
 	Score: <span class="score">{{ act_score.score }}</span>
	Votes: <span class="num_votes">{{ act_score.num_votes }}</span>
      </div>
    </div>
    {% else %}
    <div class="voting-box" id="act_{{ object.id }}">
      <h1>Vote this act</h1>
      <ul>
	<li><a onclick="vote_act('{{ object.id }}', 'up');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>
	<li><a onclick="vote_act('{{ object.id }}', 'down');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>
      </ul>
      <div class="voting-score">
 	Score: <span class="score">{{ act_score.score }}</span>
	Votes: <span class="num_votes">{{ act_score.num_votes }}</span>
      </div>
    </div>
    {% endif %}

    <br clear="all" />
    <br />
    <div id="comment-area">
      <h1>Comments</h1>
      <p>Total number of comments: {{ comment_count }}.</p>
      {% for comment in comment_list %}
      <div class="comment-box" id="comment_{{ comment.id }}">
	<div class="comment-content">
	  <div class="comment-author">{{ comment.user_name }}</div>
	  <div class="comment-date">{{ comment.submit_date|date:"d M Y" }}</div>
	  <div class="comment-text">{{ comment.comment }}</div>
	</div>
	{% score_for_object comment as comment_score %}
	{% if request.user.is_authenticated %}
	{% vote_by_user request.user on comment as vote %}
	<div class="voting-box">
	  <h1>Vote this comment</h1>
	  <ul>
	    {% if vote.vote < 0 %}
	    <li><a onclick="vote_comment('{{ comment.id }}', 'up');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>
	    <li><a onclick="vote_comment('{{ comment.id }}', 'clear');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down.png" /></a></li>
	    {% else %}{% if vote.vote > 0 %}
	    <li><a onclick="vote_comment('{{ comment.id }}', 'clear');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up.png" /></a></li>
	    <li><a onclick="vote_comment('{{ comment.id }}', 'down');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>
	    {% else %}
	    <li><a onclick="vote_comment('{{ comment.id }}', 'up');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>
	    <li><a onclick="vote_comment('{{ comment.id }}', 'down');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>
	    {% endif %}
	    {% endif %}
	  </ul>
	  <div class="voting-score">
	    Score: <span class="score">{{ comment_score.score }}</span>
	    Votes: <span class="num_votes">{{ comment_score.num_votes }}</span>
	  </div>
	</div>
	{% else %}
	<div class="voting-box">
	  <h1>Vote this comment</h1>
	  <ul>
	    <li><a onclick="vote_comment('{{ comment.id }}', 'up');"><img alt="Vote up" src="{{ STATIC_URL }}img/thumb-up-grey.png" /></a></li>
	    <li><a onclick="vote_comment('{{ comment.id }}', 'down');"><img alt="Vote down" src="{{ STATIC_URL }}img/thumb-down-grey.png" /></a></li>
	  </ul>
	  <div class="voting-score">
	    Score: <span class="score">{{ comment_score.score }}</span>
	    Votes: <span class="num_votes">{{ comment_score.num_votes }}</span>
	  </div>
	</div>
	{% endif %}
      </div>
      {% endfor %}
      {% if request.user.is_authenticated %}
      <div id="comment-form-wrapper">
	<h1>Add your comment as {{ request.user.username|capfirst }}</h1>
	<table>
	  <form action="{% comment_form_target %}" method="post">
	    {% csrf_token %}
	    {{ form }}
	    <tr>
	      <td colspan="2">
		<input type="submit" name="submit" value="Post">
		<input type="submit" name="preview" value="Preview">
	      </td>
	    </tr>
	  </form>
	</table>
	{% endif %}
      </div>
    </div>
  </section><!-- end of #content -->  
{% endblock %}
